{
  "hash": "4aae71d87efa6e0c1f6da7663fc472fa",
  "result": {
    "engine": "knitr",
    "markdown": "---\ntitle: \"Replication Code\"\nsubtitle: \"'When Strikes Meet Stocks: The Complex Interplay Between Organized Labor and Employee Stock Ownership'\"\nauthor: Lydia Camp\ndate: last-modified\nformat:\n  html:\n    theme: cosmo\n    toc: true\n    toc-depth: 3\n    code-fold: true\n    code-summary: \"Show code\"\n    code-copy: true\n    code-overflow: wrap\nexecute:\n  eval: false\n  echo: true\n  warning: false\n  message: false\n---\n\n# Load Packages and Import Data\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Load Packages\nlibrary(tidyverse)\nlibrary(lmtest)\nlibrary(sandwich)\nlibrary(fixest)\nlibrary(did)\nlibrary(panelView)\nlibrary(car)\nlibrary(showtext)\nlibrary(usmap)\nlibrary(grid)\nlibrary(data.table)\nlibrary(FNN)\nlibrary(stringr)\nlibrary(plm)\nlibrary(scales)\nlibrary(sf)\nlibrary(modelsummary)\nlibrary(twfeivdecomp)\nlibrary(devtools)\ninstall_github(\"tye27/idid\")\nlibrary(idid)\n\n# Load Data\nsetwd(\"your/working/directory\")\ndf <- read_csv(\"df.csv\")\n\n# Exclude 1999\nstate_year <- df |> \n  filter(year != 1999) \n```\n:::\n\n\n# Descriptive Statistics\n\n## Table 2: Descriptive Statistics\n\n\n::: {.cell}\n\n```{.r .cell-code}\noptions(scipen = 999)\n\nvars <- c(\n  \"num_esops_form_5500\",\n  \"union_density\",\n  \"num_strikes\",\n  \"left_wing\",\n  \"ln_state_pop\",\n  \"ln_manufact\",\n  \"manufact_per\",\n  \"ln_real_median_in\",\n  \"ln_num_firms\"\n)\n\ndescriptives <- state_year |> \n  summarise(across(all_of(vars),\n                   list(N = ~sum(!is.na(.)),\n                        Mean = ~mean(., na.rm=TRUE),\n                        SD = ~sd(., na.rm=TRUE),\n                        Min = ~min(., na.rm=TRUE),\n                        Max = ~max(., na.rm=TRUE)),\n                   .names = \"{.col}_{.fn}\")) |> \n  as.list() |> \n  stack() |> \n  tidyr::separate(ind, into = c(\"Variable\",\"Statistic\"), sep = \"_(?=[^_]+$)\") |>  \n  tidyr::pivot_wider(names_from = Statistic, values_from = values)\n\ndescriptives[-1] <- round(descriptives[-1], 3)\n\ndescriptives\n```\n:::\n\n\n## Figure 2: Map of RTW Adoption\n\n\n::: {.cell}\n\n```{.r .cell-code}\nrtw_years <- tribble(\n  ~abbr, ~year,\n  \"AL\", 1953, \"AR\", 1944, \"AZ\", 1946, \"FL\", 1944, \"GA\", 1947,\n  \"IA\", 1947, \"ID\", 1985, \"IN\", 2012, \"KS\", 1958, \"KY\", 2017,\n  \"LA\", 1976, \"MS\", 1954, \"NC\", 1947, \"ND\", 1947, \"NE\", 1946,\n  \"NV\", 1952, \"OK\", 2001, \"SC\", 1954, \"SD\", 1948, \"TN\", 1947,\n  \"TX\", 1947, \"UT\", 1955, \"VA\", 1947, \"WI\", 2015, \"WV\", 2016,\n  \"WY\", 1963, \"MI\", 2012\n) |>\n  mutate(\n    decade = cut(\n      year,\n      breaks = c(1939, 1949, 1959, 1979, 1999, 2009, 2019),\n      labels = c(\"1940-49\", \"1950-59\", \"1960-79\", \"1980-99\", \"2000-09\", \"2010-19\"),\n      right = TRUE\n    )\n  )\n\nstates_poly <- us_map(regions = \"states\") |>\n  st_as_sf(coords = c(\"x\", \"y\"), crs = 4326, agr = \"constant\") |>\n  group_by(abbr) |>\n  summarise(geometry = st_union(st_geometry(.)), .groups = \"drop\") |>\n  st_as_sf()\n\nblues <- c(\n  \"1940-49\" = \"#E8F1FF\",\n  \"1950-59\" = \"#B3CDEB\",\n  \"1960-79\" = \"#96C3E3\",\n  \"1980-99\" = \"#64AAD4\",\n  \"2000-09\" = \"#2E7CB8\",\n  \"2010-19\" = \"#084A8C\"\n)\n\nsf_map <- states_poly |>\n  left_join(rtw_years, by = \"abbr\")\n\nlabels_sf <- sf_map |>\n  filter(!is.na(year)) |>\n  mutate(\n    label_pt    = st_point_on_surface(st_geometry(.)),\n    label_color = if_else(decade == \"2010-19\", \"white\", \"black\")\n  )\n\np <- ggplot(sf_map) +\n  geom_sf(aes(fill = decade), color = \"black\", linewidth = 0.25) +\n  geom_sf_text(\n    data = labels_sf,\n    aes(geometry = label_pt, label = year, color = label_color),\n    family = \"Times New Roman\",\n    size = 2.8\n  ) +\n  scale_fill_manual(\n    values = blues,\n    na.value = \"white\",\n    drop = FALSE,\n    name = NULL\n  ) +\n  scale_color_identity() +\n  coord_sf(datum = NA) +\n  theme_void(base_family = \"Times New Roman\") +\n  theme(\n    legend.position = c(0.05, 0.7)\n  )\n\np\n```\n:::\n\n\n![](images/rtw_adoption_map.png)\n\n# OLS: Union Density -\\> ESOPs\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Sort the panel\nstate_year <- state_year |> \n  arrange(state, year)\n\n# Lag 4 years\nxm4 <- plm(\n  num_esops_form_5500 ~ \n    lag(num_esops_form_5500, 4) +\n    lag(union_density, 4) +\n    lag(I(union_density^2), 4) +\n    lag(left_wing, 4) +\n    lag(manufact_per, 4) +\n    lag(log(real_median_in), 4) +\n    lag(log(state_pop), 4) +\n    lag(log(num_firms), 4),\n  data   = state_year,\n  index  = c(\"state\", \"year\"),\n  model  = \"within\",\n  effect = \"twoways\"\n)\n\n# Lag 5 years\nxm5 <- plm(\n  num_esops_form_5500 ~ \n     lag(num_esops_form_5500, 5) +\n    lag(union_density, 5) +\n    lag(I(union_density^2), 5) +\n    lag(left_wing, 5) +\n    lag(manufact_per, 5) +\n    lag(log(real_median_in), 5) +\n    lag(log(state_pop), 5) +\n    lag(log(num_firms), 5),\n  data   = state_year,\n  index  = c(\"state\", \"year\"),\n  model  = \"within\",\n  effect = \"twoways\"\n)\n\n# Lag 6 years\nxm6 <- plm(\n  num_esops_form_5500 ~ \n    lag(num_esops_form_5500, 6) +\n    lag(union_density, 6) +\n    lag(I(union_density^2), 6) +\n    lag(left_wing, 6) +\n    lag(manufact_per, 6) +\n    lag(log(real_median_in), 6) +\n    lag(log(state_pop), 6) +\n    lag(log(num_firms), 6),\n  data   = state_year,\n  index  = c(\"state\", \"year\"),\n  model  = \"within\",\n  effect = \"twoways\"\n)\n```\n:::\n\n\n## Table A1: OLS Regressions\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Create OLS Model Summary\n\ncoef_map <- c(\n  \"lag(union_density, 4)\"      = \"Union density\",\n  \"lag(union_density, 5)\"      = \"Union density\",\n  \"lag(union_density, 6)\"      = \"Union density\",\n\n  \"lag(I(union_density^2), 4)\" = \"Union density$^2$\",\n  \"lag(I(union_density^2), 5)\" = \"Union density$^2$\",\n  \"lag(I(union_density^2), 6)\" = \"Union density$^2$\",\n\n  \"lag(left_wing, 4)\"          = \"Left-wing government\",\n  \"lag(left_wing, 5)\"          = \"Left-wing government\",\n  \"lag(left_wing, 6)\"          = \"Left-wing government\",\n\n  \"lag(manufact_per, 4)\"       = \"Manufacturing employment share\",\n  \"lag(manufact_per, 5)\"       = \"Manufacturing employment share\",\n  \"lag(manufact_per, 6)\"       = \"Manufacturing employment share\",\n\n  \"lag(log(real_median_in), 4)\" = \"Log real median income\",\n  \"lag(log(real_median_in), 5)\" = \"Log real median income\",\n  \"lag(log(real_median_in), 6)\" = \"Log real median income\",\n\n  \"lag(log(state_pop), 4)\"     = \"Log population\",\n  \"lag(log(state_pop), 5)\"     = \"Log population\",\n  \"lag(log(state_pop), 6)\"     = \"Log population\",\n\n  \"lag(log(num_firms), 4)\"     = \"Log number of firms\",\n  \"lag(log(num_firms), 5)\"     = \"Log number of firms\",\n  \"lag(log(num_firms), 6)\"     = \"Log number of firms\",\n  \n  \"lag(num_esops_form_5500, 4)\" = \"LDV\",\n  \"lag(num_esops_form_5500, 5)\" = \"LDV\",\n  \"lag(num_esops_form_5500, 6)\" = \"LDV\"\n  \n)\n\nmodels <- list(\n  \"Lag 4 Years\" = xm4,\n  \"Lag 5 Years\" = xm5,\n  \"Lag 6 Years\" = xm6\n)\n\nfe_rows <- data.frame(\n  term = c(\"State FE\", \"Year FE\"),\n  `Lag 4 Years` = c(\"✓\", \"✓\"),\n  `Lag 5 Years` = c(\"✓\", \"✓\"),\n  `Lag 6 Years` = c(\"✓\", \"✓\"),\n  stringsAsFactors = FALSE\n)\n\nmodelsummary(\n  models,\n  coef_rename = coef_map,\n  stars = TRUE,\n  statistic = \"std.error\",\n  add_rows = fe_rows,\n gof_map = c(\"nobs\", \"r.squared\")\n)\n```\n:::\n\n\n# Clean Data for DiD\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Create RTW year variable (1 if always, 0 if never, 0 or 1 if switch)\nstate_year <- df |> \n  group_by(state) |> \n  mutate(\n    rtw_year = ifelse(\n      any(rtw == 1),\n      min(year[rtw == 1], na.rm = TRUE),\n      NA_integer_\n    )\n  ) |> \n  ungroup()\n\n# Create groups\nstate_year <- state_year |> \n  group_by(state) |> \n  mutate(\n    ever_treated   = any(rtw == 1),\n    never_treated  = all(rtw == 0),\n    always_treated = all(rtw == 1),\n    switcher       = ever_treated & !always_treated\n  ) |> \n  ungroup()\n\nstate_year <- state_year |> \n  mutate(\n    treated_it = ifelse(!is.na(rtw_year) & year >= rtw_year, 1L, 0L),\n    event_time = year - rtw_year\n  )\n\n# drop always treated\ndid_data <- state_year |> \n  filter(!state %in% c(\"NE\", \"MO\")) |> \n  group_by(state) |> \n  mutate(always_treated = all(rtw == 1)) |> \n  ungroup() |> \n  filter(!always_treated)\n```\n:::\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Drop Oklahoma\ndid_data <- did_data |> \n  filter(state !=\"OK\")\n\n# Give all never adopters a value of 0 for comparison\ndid_data <- did_data |>\n  mutate(\n    rtw_year = ifelse(is.na(rtw_year), 0, rtw_year)\n  )\n\n# Add ID\ndid_data$id <- as.integer(factor(did_data$state))\n\n# Remove 1999\ndid_data2 <- did_data |> \n  filter(year !=1999)\n```\n:::\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Lag Controls\ndid_data2 <- did_data2 |> \n  arrange(id, year) |> \n  group_by(id) |> \n  mutate(\n    ln_state_pop_l1 = lag(ln_state_pop, 1),\n    manufact_per_l1   = lag(manufact_per, 1),\n    ln_real_median_in_l1 = lag(ln_real_median_in, 1),\n    real_median_in_l1 = lag(real_median_in, 1),\n    ln_num_firms_l1   = lag(ln_num_firms, 1),\n    left_wing_l1      = lag(left_wing, 1),\n    union_density_l1 = lag(union_density, 1),\n    num_strikes_l1 = lag(num_strikes, 1),\n\n    # 2-year lags for robustness\n    ln_state_pop_l2 = lag(ln_state_pop, 2),\n    manufact_per_l2   = lag(manufact_per, 2),\n    ln_real_median_in_l2 = lag(ln_real_median_in, 2),\n     real_median_in_l2 = lag(real_median_in, 2),\n    ln_num_firms_l2   = lag(ln_num_firms, 2),\n    left_wing_l2      = lag(left_wing, 2),\n    union_density_l2 = lag(union_density, 2),\n    num_strikes_l2 = lag(num_strikes, 2),\n  ) |> \n  ungroup()\n\n# Data excluding WI\ndid_data_no_wisconsin <- did_data2 |> \n  filter(state != \"WI\")\n```\n:::\n\n\n# Test DiD Assumptions\n\n## Table 3: Balance Test\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# define treated and control\nbalance_data <- did_data2 |> \n  mutate(treated = as.integer(rtw_year > 0)) \n\n# keep only pretreatment stuff\nbalance_data_pre <- balance_data |> \n  filter(\n    (treated == 1 & year < rtw_year) |\n      (treated == 0)\n  )\n\nbalance_vars <- c(\n  \"ln_state_pop\",\n  \"manufact_per\",\n  \"ln_real_median_in\",\n  \"ln_num_firms\",\n  \"union_density\",\n  \"left_wing\"\n)\n\n# means / sds / Ns by treated vs control + differences\nbalance_means <- balance_data_pre |> \n  select(treated, all_of(balance_vars)) |> \n  pivot_longer(\n    cols = -treated,\n    names_to = \"variable\",\n    values_to = \"value\"\n  ) |> \n  group_by(variable, treated) |> \n  summarise(\n    mean = mean(value, na.rm = TRUE),\n    sd   = sd(value, na.rm = TRUE),\n    n    = sum(!is.na(value)),\n    .groups = \"drop\"\n  ) |> \n  pivot_wider(\n    names_from = treated,\n    values_from = c(mean, sd, n),\n    names_glue = \"{.value}_{treated}\"\n  ) |> \n  mutate(\n    diff = mean_1 - mean_0\n  )\n\n# run t test for each variable\ndiff_tests <- lapply(balance_vars, function(v) {\n  ttest <- t.test(balance_data_pre[[v]] ~ balance_data_pre$treated)\n  data.frame(\n    variable = v,\n    p_value  = ttest$p.value\n  )\n}) |> \n  bind_rows()\n\ntable3 <- balance_means |> \n  left_join(diff_tests, by = \"variable\") |> \n  mutate(\n    stars = case_when(\n      p_value < 0.01 ~ \"***\",\n      p_value < 0.05 ~ \"**\",\n      p_value < 0.10 ~ \"*\",\n      TRUE ~ \"\"\n    )\n  ) |> \n  transmute(\n    Variable   = variable,\n    Treated    = round(mean_1, 3),\n    Control    = round(mean_0, 3),\n    Difference = paste0(round(diff, 3), stars),\n    N_Treated  = n_1,\n    N_Control  = n_0\n  )\n\ntable3\n```\n:::\n\n\n## Figure 3: Parallel Trends\n\n\n::: {.cell}\n\n```{.r .cell-code}\ntreated_states <- c(\"MI\", \"WI\", \"IN\", \"KY\", \"WV\")\n\ntreated_df <- did_data2 |> \n  filter(state %in% treated_states)\n\ncontrol_avg <- did_data2 |> \n  filter(!state %in% treated_states) |> \n  group_by(year) |> \n  summarize(\n    avg_esops = mean(num_esops_form_5500, na.rm = TRUE),\n    .groups = \"drop\"\n  )\n\np2 <- ggplot(treated_df, aes(x = year, y = num_esops_form_5500, group = state)) +\n  geom_line(\n    data = treated_df |> \n      filter(year <= rtw_year),\n    aes(color = \"Pre-RTW\"),\n    size = 1.5\n  ) +\n  geom_line(\n    data = treated_df |> filter(year >= rtw_year),\n    aes(color = \"Post-RTW\"),\n    size = 1.5\n  ) +\n  geom_line(\n    data = control_avg,\n    aes(x = year, y = avg_esops, color = \"Controls\", group = 1),\n    size = 2\n  ) +\n  geom_text(\n    data = ~ dplyr::filter(.x, year == max(year)),\n    aes(label = state),\n    hjust = -0.1,\n    size = 7.5,              \n    color = \"black\"\n  ) +\n  scale_color_manual(\n    name = \"\",\n    values = c(\n      \"Pre-RTW\"  = \"gray50\",\n      \"Post-RTW\" = \"blue\",\n      \"Controls\" = \"red\"\n    )\n  ) +\n  labs(\n    x = \"\",\n    y = \"Number of ESOPs\"\n  ) +\n  theme_minimal(base_family = \"Times New Roman\") +\n  theme(\n    panel.grid.major.x = element_blank(),\n    panel.grid.minor.x = element_blank(),\n    panel.grid.major.y = element_line(color = \"gray70\", linewidth = 0.4),\n    panel.grid.minor.y = element_line(color = \"gray80\", linewidth = 0.3),\n    axis.text  = element_text(size = 25),\n    axis.title = element_text(size = 25),\n    legend.text = element_text(size = 30),\n    panel.border = element_rect(color = \"black\", fill = NA, linewidth = 2),\n    legend.position = \"bottom\",\n    legend.box = \"horizontal\"\n  ) +\n  scale_y_continuous(\n  breaks = c(0, 50, 100, 150, 200, 250)\n)\n\np2\nggsave(\"p2_wide.png\", plot = p2, width = 12, height = 8, units = \"in\", dpi = 300)\n```\n:::\n\n\n![](images/pretrends_treated_vs_controls.png)\n\n### Wald Estimator: Parallel Trends\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Run Model (With Wisconsin)\natt_all <- att_gt(\n  yname  = \"num_esops_form_5500\",\n  tname  = \"year\",\n  idname = \"id\",\n  gname  = \"rtw_year\",\n  xformla = ~ manufact_per_l1 +\n              ln_real_median_in_l1 +\n              ln_num_firms_l1 +\n              ln_state_pop_l1,\n  data = did_data2\n)\n\natt_event <- aggte(att_all, type = \"dynamic\")\n\negt <- att_event$egt\natt <- att_event$att.egt\n\n# indices for pre-treatment event times (leads)\npre_idx <- which(egt < 0 & !is.na(att))\ninffunc <- att_event$inf.function$dynamic.inf.func.e\n\nVfull <- crossprod(inffunc) / nrow(inffunc)\nb <- att[pre_idx]\nV <- Vfull[pre_idx, pre_idx, drop = FALSE]\n\n# Wald test\nW <- as.numeric(t(b) %*% solve(V) %*% b)\ndf <- length(b)\npval <- 1 - pchisq(W, df)\n\nc(Wald = W, df = df, p_value = pval)\n```\n:::\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Run Model (Without Wisconsin)\natt_no_wisc <- att_gt(\n  yname  = \"num_esops_form_5500\",\n  tname  = \"year\",\n  idname = \"id\",\n  gname  = \"rtw_year\",\n  xformla = ~ manufact_per_l1 +\n              ln_real_median_in_l1 +\n              ln_num_firms_l1 +\n              ln_state_pop_l1,\n  data = did_data_no_wisconsin\n)\n\natt_event <- aggte(att_no_wisc, type = \"dynamic\")\n\negt <- att_event$egt\natt <- att_event$att.egt\n\n# indices for pre-treatment event times (leads)\npre_idx <- which(egt < 0 & !is.na(att))\ninffunc <- att_event$inf.function$dynamic.inf.func.e\n\nVfull <- crossprod(inffunc) / nrow(inffunc)\nb <- att[pre_idx]\nV <- Vfull[pre_idx, pre_idx, drop = FALSE]\n\n# Wald test\nW <- as.numeric(t(b) %*% solve(V) %*% b)\ndf <- length(b)\npval <- 1 - pchisq(W, df)\n\nc(Wald = W, df = df, p_value = pval)\n```\n:::\n\n\n## Visualize Adoption\n\n\n::: {.cell}\n\n```{.r .cell-code}\ndf <- did_data2 |>\n  filter(year >= 2008) |>\n  group_by(state) |>\n  mutate(\n    treat_year = if (any(rtw == 1, na.rm = TRUE))\n      min(year[rtw == 1], na.rm = TRUE) else Inf\n  ) |>\n  ungroup()\n\ndf_plot <- df |>\n  filter(is.finite(treat_year)) |>\n  mutate(\n    state_ordered = reorder(state, treat_year),\n    status = ifelse(rtw == 1, \"Treated\", \"Not treated\")\n  ) \n\n\nadoption <- ggplot(df_plot, aes(x = year, y = state_ordered, fill = status)) +\n  geom_tile() +\n  scale_fill_manual(\n    values = c(\n      \"Not treated\" = \"#c6dbef\",  \n      \"Treated\"     = \"#2171b5\"   \n    )\n  ) +\n  scale_x_continuous(\n  breaks = c(2008, 2010, 2012, 2014, 2016, 2018, 2020)\n) +\n  labs(x = \"Year\", y = \"State\", fill = NULL) +\n theme_classic( base_size = 14) +\n  theme(\n    axis.text.y   = element_text(size = 15),\n    axis.text.x   = element_text(size = 17),\n    axis.title    = element_text(size = 17),\n    legend.text   = element_text(size = 15),\n    legend.position = \"bottom\",\n    legend.direction = \"horizontal\"\n  )\n\nadoption\n```\n:::\n\n\n# First Stage: RTW -\\> Union Density\n\n## Run Models\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# With Wisconsin\natt_all_union <- att_gt(yname = \"union_density\",\n                        tname = \"year\",\n                        idname = \"id\",\n                        gname = \"rtw_year\",\n                        xformla = ~ manufact_per_l1 +\n             ln_real_median_in_l1 + ln_num_firms_l1,\n                        data = did_data2)\natt_overall2 <- aggte(\n  att_all_union,\n  type = \"simple\"\n)\n\n# Without Wisconsin\natt_no_wisc_union <- att_gt(yname = \"union_density\",\n                        tname = \"year\",\n                        idname = \"id\",\n                        gname = \"rtw_year\",\n                        xformla = ~  manufact_per_l1 +\n             real_median_in_l1 + ln_num_firms_l1, \n                        data = did_data_no_wisconsin)\n\natt_overall_no_wisc2 <- aggte(\n  att_no_wisc_union,\n  type = \"simple\"\n)\n```\n:::\n\n\n## ATT Table 1\n\n\n::: {.cell}\n\n```{.r .cell-code}\nextract_att <- function(x) {\n  att <- x$overall.att\n  se  <- x$overall.se\n  ci_l <- att - 1.96 * se\n  ci_u <- att + 1.96 * se\n\n  z <- att / se\n  p <- 2 * (1 - pnorm(abs(z)))\n  stars <- ifelse(p < 0.001, \"***\",\n           ifelse(p < 0.01,  \"**\",\n           ifelse(p < 0.05,  \"*\",\n           ifelse(p < 0.10,  \"+\", \"\"))))\n\n  data.frame(\n    ATT = att,\n    SE = se,\n    CI_low = ci_l,\n    CI_high = ci_u,\n    p_value = p,\n    stars = stars\n  )\n}\n\nr_all  <- extract_att(att_overall2);         r_all$Sample  <- \"All states\"\nr_nowi <- extract_att(att_overall_no_wisc2); r_nowi$Sample <- \"Excluding Wisconsin\"\n\natt_table <- rbind(r_all, r_nowi)\n\n# Make it pretty\natt_table <- att_table[, c(\"Sample\",\"ATT\",\"SE\",\"CI_low\",\"CI_high\",\"stars\",\"p_value\")]\natt_table$ATT  <- round(att_table$ATT, 3)\natt_table$SE   <- round(att_table$SE, 3)\natt_table$CI_low  <- round(att_table$CI_low, 3)\natt_table$CI_high <- round(att_table$CI_high, 3)\natt_table$p_value <- signif(att_table$p_value, 3)\n\natt_table\n```\n:::\n\n\n## Compute Quantifiable Change\n\n\n::: {.cell}\n\n```{.r .cell-code}\ndyn <- aggte(att_all_union, type = \"dynamic\")  \nsummary(dyn)\n\natt_table_pp <- data.frame(\n  event_time = dyn$egt,\n  att_pp     = dyn$att.egt,\n  se_pp      = dyn$se.egt\n) |> \n  filter(event_time >= 1 & event_time <= 9) |> \n  mutate(\n    ci95_lo_pp = att_pp - 1.96 * se_pp,\n    ci95_hi_pp = att_pp + 1.96 * se_pp\n  ) |> \n  select(\n    event_time,\n    att_pp,\n    ci95_lo_pp,\n    ci95_hi_pp\n  )\n\natt_table_pp\n```\n:::\n\n\n## Figure 4: Trends in Union Density\n\n\n::: {.cell}\n\n```{.r .cell-code}\nrtw_timing <- tribble(\n  ~state, ~rtw_year2,\n  \"AL\", 1953, \"AR\", 1944, \"AZ\", 1946, \"FL\", 1944, \"GA\", 1947,\n  \"IA\", 1947, \"ID\", 1985, \"IN\", 2012, \"KS\", 1958, \"KY\", 2017,\n  \"LA\", 1976, \"MS\", 1954, \"NC\", 1947, \"ND\", 1947, \"NE\", 1946,\n  \"NV\", 1952,              # OK removed\n  \"SC\", 1954, \"SD\", 1948, \"TN\", 1947,\n  \"TX\", 1947, \"UT\", 1955, \"VA\", 1947, \"WI\", 2015, \"WV\", 2016,\n  \"WY\", 1963, \"MI\", 2012\n)\n\nstate_year_classified <- df |>\n  full_join(rtw_timing, by = \"state\") |>\n  mutate(\n    rtw_group = case_when(\n      is.na(rtw_year2)  ~ \"Never RTW\",\n      rtw_year2 < 2000  ~ \"Always RTW\",\n      rtw_year2 >= 2000 ~ \"RTW-Switchers\"\n    )\n  )\n\n\nplot_df <- state_year_classified |>\n  mutate(\n    rtw_group = case_when(\n      always_treated == TRUE ~ \"Always RTW\",\n      switcher == TRUE       ~ \"RTW-Switchers\",\n      never_treated == TRUE  ~ \"Never RTW\",\n      TRUE                   ~ NA_character_\n    )\n  ) |>\n  group_by(year, rtw_group) |>\n  summarise(\n    union_density = mean(union_density, na.rm = TRUE),\n    .groups = \"drop\"\n  )\n\nplot_df <- plot_df |> \n  filter(year !=1999)\n\np_union <- ggplot(\n  plot_df,\n  aes(x = year, y = union_density, color = rtw_group, linetype = rtw_group)\n) +\n  geom_line(linewidth = 1.2) +\n\n  scale_color_manual(\n    values = c(\n      \"Always RTW\"    = \"grey40\",\n      \"RTW-Switchers\" = \"blue\",\n      \"Never RTW\"     = \"red\"\n    )\n  ) +\n  scale_linetype_manual(\n    values = c(\n      \"Always RTW\"    = \"solid\",\n      \"RTW-Switchers\" = \"dashed\",\n      \"Never RTW\"     = \"solid\"\n    )\n  ) +\n\n  labs(\n    x = \"Year\",\n    y = \"Union Density\",\n    color = NULL,\n    linetype = NULL\n  ) +\n\n  theme_minimal() +\n  theme(\n     panel.grid.major.x = element_blank(),\n    panel.grid.minor.x = element_blank(),\n    panel.grid.major.y = element_line(color = \"gray80\", linewidth = 0.5),\n    panel.grid.minor.y =element_line(color = \"gray90\", linewidth = 0.5),\n    plot.title = element_text(size = 18, hjust = 0.5),\n    axis.title = element_text(size = 18),\n    axis.text  = element_text(size = 17),\n    panel.border = element_rect(\n      color = \"black\",\n      fill  = NA,\n      linewidth = 0.6\n    ),\n    legend.position = \"bottom\",\n    legend.text = element_text(size = 14)\n  ) \n\np_union\n```\n:::\n\n\n![](images/union_density-01.png)\n\n## Figure 5: RTW on Union Density\n\n\n::: {.cell}\n\n```{.r .cell-code}\natt_aggregate_no_wisc_union <- aggte(\n  att_no_wisc_union,\n  type = \"dynamic\",\n  min_e = -10,\n  max_e = 10\n)\n\nggdid(att_aggregate_no_wisc_union) +\n  geom_hline(\n    yintercept = 0,\n    linetype = \"solid\",\n    linewidth = 0.6,\n    color = \"black\"\n  ) +\n  geom_vline(\n    xintercept = -0.5,\n    linetype = \"dashed\",\n    linewidth = 0.6,\n    color = \"black\"\n  ) +\n  coord_cartesian(ylim = c(-5, 5)) +\n  scale_color_manual(\n    values = c(\"grey50\", \"blue\"),\n    labels = c(\"Pre\", \"Post\")\n  ) +\n  scale_fill_manual(\n    values = c(\"gray80\", \"gray70\"),\n    labels = c(\"Pre\", \"Post\")\n  ) +\n  labs(\n    title = \"Effect of RTW on Union Density\",\n    color = NULL,\n    fill = NULL\n  ) +\n  theme(\n    panel.grid.major.x = element_blank(),\n    panel.grid.minor = element_blank(),\n    panel.grid.major.y = element_line(color = \"gray85\", linewidth = 0.4),\n    panel.border = element_rect(\n      color = \"black\",\n      fill = NA,\n      linewidth = 0.6\n    ),\n    axis.text = element_text(size = 14),\n    axis.title = element_text(size = 15),\n    legend.text = element_text(size = 15),\n    legend.title = element_blank()\n  )\n```\n:::\n\n\n![](images/ggdid_union-01.png)\n\n# Reduced Form: RTW -\\> ESOPs\n\n## Run Models\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# With WI\natt_all <- att_gt(yname = \"num_esops_form_5500\",\n                        tname = \"year\",\n                        idname = \"id\",\n                        gname = \"rtw_year\",\n                        xformla = ~ manufact_per_l1 +\n             ln_real_median_in_l1 + ln_num_firms_l1, \n                        data = did_data2)\n\natt_overall <- aggte(\n  att_all,\n  type = \"simple\"\n)\n\n# Without WI\natt_no_wisc <- att_gt(yname = \"num_esops_form_5500\",\n                        tname = \"year\",\n                        idname = \"id\",\n                        gname = \"rtw_year\",\n                        xformla = ~  manufact_per_l1 +\n             real_median_in_l1 + ln_num_firms_l1,\n                        data = did_data_no_wisconsin)\n\natt_overall_no_wisc <- aggte(\n  att_no_wisc,\n  type = \"simple\"\n)\n```\n:::\n\n\n## ATT Table 2\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Models\natt_overall <- aggte(\n  att_all,\n  type = \"simple\"\n)\n\natt_overall_no_wisc <- aggte(\n  att_no_wisc,\n  type = \"simple\"\n)\n\nr_all  <- extract_att(att_overall);         r_all$Sample  <- \"All states\"\nr_nowi <- extract_att(att_overall_no_wisc); r_nowi$Sample <- \"Excluding Wisconsin\"\n\natt_table <- rbind(r_all, r_nowi)\n\n# Make it pretty\natt_table <- att_table[, c(\"Sample\",\"ATT\",\"SE\",\"CI_low\",\"CI_high\",\"stars\",\"p_value\")]\natt_table$ATT  <- round(att_table$ATT, 3)\natt_table$SE   <- round(att_table$SE, 3)\natt_table$CI_low  <- round(att_table$CI_low, 3)\natt_table$CI_high <- round(att_table$CI_high, 3)\natt_table$p_value <- signif(att_table$p_value, 3)\n\natt_table\n```\n:::\n\n\n## Compute Quantifiable Changes\n\n\n::: {.cell}\n\n```{.r .cell-code}\ndyn2 <- aggte(att_no_wisc, type = \"dynamic\")  \nsummary(dyn2)\n\natt_table_pp2 <- data.frame(\n  event_time = dyn2$egt,\n  att_pp     = dyn2$att.egt,\n  se_pp      = dyn2$se.egt\n) |> \n  filter(event_time >= 1 & event_time <= 9) |> \n  mutate(\n    ci95_lo_pp = att_pp - 1.96 * se_pp,\n    ci95_hi_pp = att_pp + 1.96 * se_pp\n  ) |> \n  select(\n    event_time,\n    att_pp,\n    ci95_lo_pp,\n    ci95_hi_pp\n  )\n\natt_table_pp2\n```\n:::\n\n\n## Figure 6: RTW on ESOPs\n\n\n::: {.cell}\n\n```{.r .cell-code}\natt_aggregate_no_wisc <- aggte(\n  att_no_wisc,\n  type = \"dynamic\",\n  min_e = -10,\n  max_e = 10\n)\n\nggdid(att_aggregate_no_wisc) +\n  geom_hline(\n    yintercept = 0,\n    linetype = \"solid\",\n    linewidth = 0.6,\n    color = \"black\"\n  ) +\n  geom_vline(\n    xintercept = -0.5,\n    linetype = \"dashed\",\n    linewidth = 0.6,\n    color = \"black\"\n  ) +\n  coord_cartesian(ylim = c(-60, 60)) +\n  scale_color_manual(\n    values = c(\"grey50\", \"red\"),\n    labels = c(\"Pre\", \"Post\")\n  ) +\n  scale_fill_manual(\n    values = c(\"gray80\", \"gray70\"),\n    labels = c(\"Pre\", \"Post\")\n  ) +\n  labs(\n    title = \"Effect of RTW on ESOPs\",\n    color = NULL,\n    fill = NULL\n  ) +\n  theme_minimal() +\n  theme(\n    panel.grid.major.x = element_blank(),\n    panel.grid.minor = element_blank(),\n    panel.grid.major.y = element_line(color = \"gray85\", linewidth = 0.4),\n    panel.border = element_rect(\n      color = \"black\",\n      fill = NA,\n      linewidth = 0.6\n    ),\n    axis.text = element_text(size = 14),\n    axis.title = element_text(size = 15),\n    legend.text = element_text(size = 15),\n    legend.title = element_blank()\n  )\n```\n:::\n\n\n![](images/ggdid_no_wisconsin.png)\n\n# Conditional Effect: RTW -\\> ESOPs (Control for Union Density)\n\n## Run Models\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Including Wisconsin\natt_all_control <- att_gt(yname = \"num_esops_form_5500\",\n                        tname = \"year\",\n                        idname = \"id\",\n                        gname = \"rtw_year\",\n                        xformla = ~ manufact_per_l1 +\n             ln_real_median_in_l1 + ln_num_firms_l1 + union_density_l1, \n                        data = did_data2)\n\n# Without Wisconsin\natt_no_wisc_control <- att_gt(yname = \"num_esops_form_5500\",\n                        tname = \"year\",\n                        idname = \"id\",\n                        gname = \"rtw_year\",\n                        xformla = ~  manufact_per_l1 +\n             real_median_in_l1 + ln_num_firms_l1 + union_density_l1,\n                        data = did_data_no_wisconsin)\n```\n:::\n\n\n## ATT Table 3\n\n\n::: {.cell}\n\n```{.r .cell-code}\natt_overall2 <- aggte(\n  att_all_control,\n  type = \"simple\"\n)\natt_overall_no_wisc2 <- aggte(\n  att_no_wisc_control,\n  type = \"simple\"\n)\n\nr_all  <- extract_att(att_overall2);         r_all$Sample  <- \"All states\"\nr_nowi <- extract_att(att_overall_no_wisc2); r_nowi$Sample <- \"Excluding Wisconsin\"\n\natt_table <- rbind(r_all, r_nowi)\n\n# Make it pretty\natt_table <- att_table[, c(\"Sample\",\"ATT\",\"SE\",\"CI_low\",\"CI_high\",\"stars\",\"p_value\")]\natt_table$ATT  <- round(att_table$ATT, 3)\natt_table$SE   <- round(att_table$SE, 3)\natt_table$CI_low  <- round(att_table$CI_low, 3)\natt_table$CI_high <- round(att_table$CI_high, 3)\natt_table$p_value <- signif(att_table$p_value, 3)\n\natt_table\n```\n:::\n\n\n# Robustness Checks\n\n## State-By-State Estimates\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# INDIANA\nindiana <- did_data2 |> \n  filter(state != \"WI\") |> \n  filter(state != \"KY\") |> \n  filter(state != \"WV\") |> \n  filter(state != \"MI\")\n\n# esops\natt_ind <- att_gt(yname = \"num_esops_form_5500\",\n                        tname = \"year\",\n                        idname = \"id\",\n                        gname = \"rtw_year\",\n                        xformla = ~ manufact_per_l1 +\n             ln_real_median_in_l1 + ln_num_firms_l1, \n                        data = indiana)\n\natt_indiana <- aggte(\n  att_ind,\n  type = \"simple\"\n)\n\n# union density\natt_ind2 <- att_gt(yname = \"union_density\",\n                        tname = \"year\",\n                        idname = \"id\",\n                        gname = \"rtw_year\",\n                        xformla = ~ manufact_per_l1 +\n             ln_real_median_in_l1 + ln_num_firms_l1, \n                        data = indiana)\n\natt_indiana2 <- aggte(\n  att_ind2,\n  type = \"simple\"\n)\n```\n:::\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# MICHIGAN\nmichigan <- did_data2 |> \n  filter(state != \"WI\") |> \n  filter(state != \"KY\") |> \n  filter(state != \"WV\") |> \n  filter(state != \"IN\")\n\n# esops\natt_mich <- att_gt(yname = \"num_esops_form_5500\",\n                        tname = \"year\",\n                        idname = \"id\",\n                        gname = \"rtw_year\",\n                        xformla = ~ manufact_per_l1 +\n             ln_real_median_in_l1 + ln_num_firms_l1,\n                        data = michigan)\natt_michigan <- aggte(\n  att_mich,\n  type = \"simple\"\n)\n\n# union density\natt_mich2 <- att_gt(yname = \"union_density\",\n                        tname = \"year\",\n                        idname = \"id\",\n                        gname = \"rtw_year\",\n                        xformla = ~ manufact_per_l1 +\n             ln_real_median_in_l1 + ln_num_firms_l1, \n                        data = michigan)\natt_michigan2 <- aggte(\n  att_mich2,\n  type = \"simple\"\n)\n```\n:::\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# WEST VIRGINIA\nwest_virg <- did_data2 |> \n  filter(state != \"WI\") |> \n  filter(state != \"KY\") |> \n  filter(state != \"MI\") |> \n  filter(state != \"IN\")\n\n# esops\natt_wv <- att_gt(yname = \"num_esops_form_5500\",\n                        tname = \"year\",\n                        idname = \"id\",\n                        gname = \"rtw_year\",\n                        xformla = ~ manufact_per_l1 +\n             ln_real_median_in_l1 + ln_num_firms_l1, \n                        data = west_virg)\natt_west_v <- aggte(\n  att_wv,\n  type = \"simple\"\n)\n\n# union denstiy\natt_wv2 <- att_gt(yname = \"union_density\",\n                        tname = \"year\",\n                        idname = \"id\",\n                        gname = \"rtw_year\",\n                        xformla = ~ manufact_per_l1 +\n             ln_real_median_in_l1 + ln_num_firms_l1, \n                        data = west_virg)\natt_west_v2 <- aggte(\n  att_wv2,\n  type = \"simple\"\n)\n```\n:::\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# KENTUCKY\nkentucky <- did_data2 |> \n  filter(state != \"WI\") |> \n  filter(state != \"WV\") |> \n  filter(state != \"MI\") |> \n  filter(state != \"IN\")\n\natt_kentuc <- att_gt(yname = \"num_esops_form_5500\",\n                        tname = \"year\",\n                        idname = \"id\",\n                        gname = \"rtw_year\",\n                        xformla = ~ manufact_per_l1 +\n             ln_real_median_in_l1 + ln_num_firms_l1, \n                        data = kentucky)\natt_kentucky <- aggte(\n  att_kentuc,\n  type = \"simple\"\n)\n\n# union density\natt_kentuc2 <- att_gt(yname = \"union_density\",\n                        tname = \"year\",\n                        idname = \"id\",\n                        gname = \"rtw_year\",\n                        xformla = ~ manufact_per_l1 +\n             ln_real_median_in_l1 + ln_num_firms_l1, \n                        data = kentucky)\natt_kentucky2 <- aggte(\n  att_kentuc2,\n  type = \"simple\"\n)\n```\n:::\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# WISCONSIN\nwisc <- did_data2 |> \n  filter(state != \"KY\") |> \n  filter(state != \"WV\") |> \n  filter(state != \"MI\") |> \n  filter(state != \"IN\")\n\n# esops\natt_wisc <- att_gt(yname = \"num_esops_form_5500\",\n                        tname = \"year\",\n                        idname = \"id\",\n                        gname = \"rtw_year\",\n                        xformla = ~ manufact_per_l1 +\n             ln_real_median_in_l1 + ln_num_firms_l1, \n                        data = wisc)\natt_wisconsin <- aggte(\n  att_wisc,\n  type = \"simple\"\n)\n\n# union density=\natt_wisc2 <- att_gt(yname = \"union_density\",\n                        tname = \"year\",\n                        idname = \"id\",\n                        gname = \"rtw_year\",\n                        xformla = ~ manufact_per_l1 +\n             ln_real_median_in_l1 + ln_num_firms_l1,\n                        data = wisc)\natt_wisconsin2 <- aggte(\n  att_wisc2,\n  type = \"simple\"\n)\n```\n:::\n\n\n## ATT Table: Disaggregated by State\n\n\n::: {.cell}\n\n```{.r .cell-code}\nr_bench <- extract\nr_ind  <- extract_att(att_indiana);         r_ind$Sample  <- \"Indiana\"\nr_mich <- extract_att(att_michigan); r_mich$Sample <- \"Michigan\"\nr_wv  <- extract_att(att_west_v);     r_wv$Sample  <- \"West Virginia\"\nr_ky <- extract_att(att_kentucky);     r_ky$Sample  <- \"Kentucky\"\nr_wisc <- extract_att(att_wisconsin);     r_wisc$Sample  <- \"Wisconsin\"\n\natt_table_states <- rbind(r_ind, r_mich, r_wv, r_ky, r_wisc)\n\n# Make it pretty\natt_table_states <- att_table_states[, c(\"Sample\",\"ATT\",\"SE\",\"CI_low\",\"CI_high\",\"stars\",\"p_value\")]\natt_table_states$ATT  <- round(att_table_states$ATT, 3)\natt_table_states$SE   <- round(att_table_states$SE, 3)\natt_table_states$CI_low  <- round(att_table_states$CI_low, 3)\natt_table_states$CI_high <- round(att_table_states$CI_high, 3)\natt_table_states$p_value <- signif(att_table_states$p_value, 3)\n\natt_table_states\n```\n:::\n\n",
    "supporting": [
      "index_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}